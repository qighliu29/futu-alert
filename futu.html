<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>futu</title>

    <style>
        .arc {
            transition: transform 0.6s;
        }
        .arc:hover {
            transform: scale(1.1);
        }
    </style>

    <script language="javascript" type="text/javascript">
        function showNotification(note) {
            if (("Notification" in window) && (Notification.permission === "granted")) {
                var n = new Notification(note.title, note);
                n.onclick = function () {
                    console.log(note.index);
                };
            } else {
                console.log("Your browser does not support Notification or it is not granted");
            }
        }

        function init() {
            doConnect();
        }

        function doConnect() {
            websocket = new WebSocket("ws://host:port/");
            websocket.onopen = function (evt) {
                onOpen(evt)
            };
            websocket.onclose = function (evt) {
                onClose(evt)
            };
            websocket.onmessage = function (evt) {
                onMessage(evt)
            };
            websocket.onerror = function (evt) {
                onError(evt)
            };

            dataTable = document.createElement('table');
            document.body.appendChild(dataTable);

            if (("Notification" in window) && !(Notification.permission === "granted")) {
                Notification.requestPermission(function (status) {
                    if (Notification.permission !== status) {
                        Notification.permission = status;
                    }
                });
            }
        }

        function onOpen(evt) {
            writeToScreen("connected\n");
        }

        function onClose(evt) {
            writeToScreen("disconnected\n");
        }

        function onMessage(evt) {
            writeToScreen("response: " + evt.data + '\n');

            var dataObj = JSON.parse(evt.data);

            var tr = document.createElement('tr');

            var tdCode = document.createElement('td');
            var code = document.createTextNode(dataObj["code"]["0"]);
            tdCode.appendChild(code);

            var tdTime = document.createElement('td');
            var time = document.createTextNode(dataObj["time"]["0"]);
            tdTime.appendChild(time);

            var tdPrice = document.createElement('td');
            var price = document.createTextNode(dataObj["price"]["0"]);
            tdPrice.appendChild(price);

            var tdVolume = document.createElement('td');
            var volume = document.createTextNode(dataObj["volume"]["0"]);
            tdVolume.appendChild(volume);

            var tdDirect = document.createElement('td');
            var direct = document.createTextNode(dataObj["ticker_direction"]["0"]);
            tdDirect.appendChild(direct);

            tr.appendChild(tdCode);
            tr.appendChild(tdTime);
            tr.appendChild(tdPrice);
            tr.appendChild(tdVolume);
            tr.appendChild(tdDirect);

            // dataTable.appendChild(tr);
            dataTable.insertBefore(tr, dataTable.firstChild);

            showNotification({
                title: dataObj["code"]["0"],
                dir: "ltr",
                lang: "utf-8",
                icon: "/icon.jpg",
                body: `[${dataObj["time"]["0"]}] ${dataObj["volume"]["0"]} ${dataObj["ticker_direction"]["0"]}`
            })
        }

        function onError(evt) {
            writeToScreen('error: ' + evt.data + '\n');
        }

        function writeToScreen(message) {
            document.myform.outputtext.value += message
            document.myform.outputtext.scrollTop = document.myform.outputtext.scrollHeight;
        }

        window.addEventListener("load", init, false);
    </script>
</head>

<body>
    <svg width="960" height="500"></svg>
    <form name="myform">
        <p>
            <textarea name="outputtext" rows="20" cols="50"></textarea>
        </p>
    </form>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.11.0/d3.min.js"></script>
    <script>
        var svg = d3.select("svg"),
            width = +svg.attr("width"),
            height = +svg.attr("height"),
            radius = Math.min(width, height) / 2,
            g = svg.append("g").attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

        var color = d3.scaleOrdinal(["#98abc5", "#8a89a6", "#7b6888"]);

        var pie = d3.pie()
            .sort(null)
            .value(function (d) {
                return d.volume;
            });

        var path = d3.arc()
            .outerRadius(radius - 10)
            .innerRadius(0);

        var label = d3.arc()
            .outerRadius(radius - 40)
            .innerRadius(radius - 40);

        var data = [{
            volume: 200
        }, {
            volume: 100
        }, {
            volume: 200
        }];

        var arc = g.selectAll(".arc")
            .data(pie(data))
            .enter().append("g")
            .attr("class", "arc");

        arc.append("path")
            .attr("d", path)
            .attr("fill", function (d, i) {
                return color(i);
            });

        arc.append("text")
            .attr("transform", function (d) {
                return "translate(" + label.centroid(d) + ")";
            })
            .attr("dy", "0.35em")
            .text(function (d) {
                return d.data.volume;
            });
    </script>
</body>

</html>